<?php

require_once("../../redcap_connect.php");

$projects = array(42231,47289,48727,48728,48729,48730,49705);
$totals = array();
$titles = array();
for ($i = 1; $i <= 31; $i++) {
    if ($i < 10) {
        $i = "0$i";
    }
    $date = "2017-03-$i";
    // echo "<h2>$date</h2>";
    foreach ($projects as $project_id) {
        $sql = "SELECT app_title FROM redcap_projects WHERE project_id = $project_id;";
        $q = db_query($sql);
        $title = "";
        while ($row = db_fetch_assoc($q)) {
            $title = $row['app_title'];
            $titles[$project_id] = $title;
        }
        $sql = "SELECT record,field_name, value
               FROM redcap_data d
               WHERE d.project_id = $project_id
                   AND d.field_name='proc_date'
                   AND d.value LIKE '$date'";
        $q = db_query($sql);
        $records = array();
        while ($row = db_fetch_assoc($q)) {
            if (!in_array($row['record'], $records)) {
                $records[] = $row['record'];
            }
        }
        // echo "$title ($project_id): ".db_num_rows($q)." records (".implode(", ", $records).") ".db_error()."<br>";
        if (!isset($totals[$project_id])) {
            $totals[$project_id] = 0;
        }
        $totals[$project_id] += db_num_rows($q);
    }
}

// echo "<h2>Totals</h2>";
// foreach ($titles as $project_id => $title) {
    // echo "$title ($project_id): {$totals[$project_id]}<br>"; 
// }

echo "<h2>Search</h2>";
$diff = ["28573-2","28574-7","28576-32","28576-33","28576-35","28577-32","28577-33","28577-35","28579-4","28579-5","28753-13","28753-14","28575-15","28575-16","28576-36","28576-37","28577-36","28577-37","28578-24","28578-90","28579-6","28579-7","28579-8","28753-15","28753-16","28753-17","28575-17","28575-18","28575-19","28576-38","28576-39","28576-40","28576-41","28576-42","28578-26","28578-27","28578-28","28578-29","28579-9","28753-18","28753-19","28753-20","28574-20","28575-20","28575-21","28576-43","28578-30","28578-31","28579-10","28579-11","28753-21","28575-22","28575-25","28577-38","28577-39","28577-40","28578-32","28578-33","28743-4","28753-22","28575-24","28753-24","28575-26","28576-44","28576-46","28576-47","28577-41","28577-42","28577-43","28577-44","28578-35","28753-25","28577-46","28577-47","28577-48","28578-36","28578-37","28578-38","28579-13","28579-14","28579-15","28753-26","28575-27","28575-28","28576-48","28576-49","28576-50","28576-51","28576-52","28576-53","28577-49","28577-50","28577-51","28577-52","28579-16","28579-17","28753-27","28753-28","28753-29","28575-29","28576-55","28576-57","28576-58","28577-53","28577-54","28577-55","28577-57","28579-18","28575-30","28577-58","28577-59","28577-60","28577-61","28577-62","28577-63","28577-64","28578-39","28578-40","28579-19","28576-59","28576-60","28576-61","28578-41","28578-42","28753-33","28575-31","28578-43","28578-44","28578-46","28579-20","28743-5","28743-6","28743-7","28575-32","28575-33","28578-47","28578-48","28578-49","28578-50","28578-51","28579-21","28579-22","28579-24","28579-25","28579-26","28743-8","28743-9","28753-37","28753-38","28576-62","28576-63","28576-64","28576-65","28578-52","28578-53","28578-54","28578-55","28579-27","28579-28","28579-29","28579-30","28743-10","28743-11","28753-39","28753-40","28578-57","28578-58","28579-31","28579-32","28579-33","28743-13","28744-10","28744-11","28744-12","28753-41","28753-42","28576-66","28578-59","28578-60","28578-61","28578-62","28579-35","28743-14","28743-15","28744-2","28744-3","28753-43","28753-44"];
$found = 0;
$foundAutomoveTwice = 0;
$foundDiff = array();
foreach ($diff as $rec) {
    $sql = "SELECT project_id, record, field_name, value
            FROM redcap_data d
            WHERE d.project_id IN (".implode(", ", $projects).")
                AND d.field_name='proc_date'
                AND d.record LIKE '%-$rec'";
    $q = db_query($sql);
    while ($row = db_fetch_assoc($q)) {
        if (preg_match("/-2017-04-/", $row['record'])) {
            if (!in_array($rec, $foundDiff)) {
                $foundDiff[] = $rec;
            }
            if (preg_match("/automoved-.+automoved-/", $row['record'], $matches)) {
                $fountAutomoveTwice++;
            }
            echo "$rec: ".json_encode($row)."<br>";
            $found++;
        }
    }
}
echo "<br>$found items found.<br>";
echo "<br>$foundAutomoveTwice items found with 2 automoved's.<br>";
echo "<br>".count($foundDiff)." items found from diff (".count($diff).").<br>";
